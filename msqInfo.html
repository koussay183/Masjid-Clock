<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุนุฏุงุฏุงุช ุงููุณุฌุฏ</title>
    <link rel="stylesheet" href="./css/styleInfo.css">
    <meta name="color-scheme" content="light only">
    <style>
        /* Loading screen styles */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
    </div>
    <div class="wrapper">
        <div class="title-text">
            <div class="title info">ุฅุนุฏุงุฏุงุช ุงููุณุฌุฏ</div>
        </div>
        <div class="form-container">
            <div class="form-inner">
                <form action="#" class="info">
                    <div class="field">
                        ุงูุจุฑูุฏ ุงูุฅููุชุฑููู<input type="text" placeholder="Email Address" id="email">
                    </div>
                    <div class="field">
                        ูููุฉ ุงูุณุฑ
                        <input type="password" placeholder="Password" id="pass">
                        <span data-target="pass" class="toggle-password">๐๏ธ</span>
                    </div>
                    <div class="field">
                        ุฑูู ุงูุฌูุงู
                        <input type="text" placeholder="Mobile (05XXXXXXXX)" id="mobile">
                    </div>
                    <div class="field">
                        ุฅุณู ุงููุณุฌุฏ
                        <input type="text" placeholder="Mosque Name" id="msqName">
                    </div>
                    <div class="field">
                        ุฎุท ุงูุนุฑุถ
                        <input type="text" placeholder="Latitude" id="lat">
                    </div>
                    <div class="field">
                        ุฎุท ุงูุทูู
                        <input type="text" placeholder="Longitude" id="long">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงููุฌุฑ
                        <input type="number" placeholder="Fajr duration" id="fajr">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงูุดุฑูู
                        <input type="number" placeholder="Sunrise duration" id="sunrise">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงูุธูุฑ
                        <input type="number" placeholder="Dhuhr duration" id="dhuhr">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงูุนุตุฑ
                        <input type="number" placeholder="Asr duration" id="asr">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงููุบุฑุจ
                        <input type="number" placeholder="Maghrib duration" id="maghrib">
                    </div>
                    <div class="field">
                        ูุชุฑุฉ ุงูุนุดุงุก
                        <input type="number" placeholder="Isha duration" id="isha">
                    </div>
                    <div class="field">
                        ุงูุฃุญุงุฏูุซ
                        <input type="text" placeholder="Hadeeth" id="hadeeth">
                    </div>
                    <div class="field">
                        ุงูุฅุนูุงูุงุช
                        <input type="text" placeholder="Advertisement" id="advertisement">
                    </div>
                    <div class="field">
                        ุดูู ุงูุดุงุดุฉ
                        <input type="text" id="screen" placeholder="Write H or V" name="screen">
                    </div>
                    <div class="field" style="height: auto; font-size: 1.3em;">
                        ุตูุฑุฉ ุงูุฎูููุฉ
                        <input type="file" id="bgImage" accept="image/*" style="display: none;">
                        <img id="imagePreview" alt="Current Background Image" style="cursor: pointer; width: 100%; max-height: 400px; border-radius: 10px;">
                        <div id="loadingMessage" style="display: none;">ุชุญููู...</div>
                    </div>
                    <div class="field" style="height: auto; font-size: 1.3em;">
                        ุงูุฃุฐุงู
                        <input type="file" id="adhanFile" accept="audio/*" style="display: none;">
                        <audio id="adhanPreview" controls style="display: none; width: 100%;"></audio>
                        <button type="button" id="deleteAdhanBtn" style="width: 100%;display: block;margin-top: 1em;border: none;border-radius: 8px;padding: .5em;background-color: #ff6a60;font-size: .9em;color: white;cursor: pointer;">ุญุฐู ุงูุฃุฐุงู</button>
                        <div id="loadingAdhanMessage" style="display: none;">ุชุญููู...</div>
                    </div>
                    <div class="field btn">
                        <div class="btn-layer"></div>
                        <input type="submit" value="ุชุฃููุฏ" id="infobtn">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAoO1sTD7c29cXuf7Ym2EFWFWf4sT-dhGQ",
            authDomain: "manarahclock.firebaseapp.com",
            projectId: "manarahclock",
            storageBucket: "manarahclock.appspot.com",
            messagingSenderId: "787657770789",
            appId: "1:787657770789:web:028b6a3eb9cc7a32827ccc"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        
        const email = document.getElementById("email");
        const password = document.getElementById("pass");
        const mobile = document.getElementById("mobile");
        const msqNameF = document.getElementById("msqName");
        const lat = document.getElementById("lat");
        const long = document.getElementById("long");
        const fajrD = document.getElementById("fajr");
        const sunriseD = document.getElementById("sunrise");
        const dhuhrD = document.getElementById("dhuhr");
        const asrD = document.getElementById("asr");
        const maghribD = document.getElementById("maghrib");
        const ishaD = document.getElementById("isha");
        const hadeeth = document.getElementById("hadeeth");
        const advertisement = document.getElementById("advertisement");
        const screen = document.getElementById("screen");
        const bgImage = document.getElementById("bgImage");
        const imagePreview = document.getElementById("imagePreview");
        const adhanFile = document.getElementById("adhanFile");
        const adhanPreview = document.getElementById("adhanPreview");
        const deleteAdhanBtn = document.getElementById("deleteAdhanBtn");
        const loadingScreen = document.getElementById('loadingScreen');
        
        let currentImageRef = null;
        let currentAdhanRef = null;
        
        const parameterValue = getParameterByName('parameter');
        
        var refRec = ref(db, `users/${parameterValue}`);
        
        console.log(parameterValue);
        
        get(refRec).then((snapshot) => {
            console.log(snapshot.val());
            
            if (snapshot.exists()) {
                let databaseValue = snapshot.val();
                fillFormFields(databaseValue);
        
                if (databaseValue.backgroundImage && databaseValue.backgroundImage !== "noBg") {
                    setImagePreview(databaseValue.backgroundImage);
                    const imageUrl = new URL(databaseValue.backgroundImage);
                    const fullPath = decodeURIComponent(imageUrl.pathname.split("/o/")[1]);
                    currentImageRef = storageRef(storage, fullPath);
                } else {
                    imagePreview.style.display = "none";
                    bgImage.style.display = "block"; // Make sure the input is visible
                }
        
                if (databaseValue.adhan && databaseValue.adhan !== "noAdhan") {
                    setAdhanPreview(databaseValue.adhan);
                } else {
                    adhanPreview.style.display = "none";
                    adhanFile.style.display = "block"; // Make sure the input is visible
                    deleteAdhanBtn.style.display = "none"; // Hide the button initially
                }
            } else {
                console.error("No data available");
            }
        }).catch((error) => {
            console.error("Error getting data:", error);
        });
        
        // here adding eventlisteners on btns forimage upload and adhen upload
        imagePreview.addEventListener('click', () => {
            bgImage.click();
        });
        
        bgImage.addEventListener('change', async () => {
            const file = bgImage.files[0];
            if (file) {
                await uploadImage(file);
            }
        });
        
        adhanFile.addEventListener('change', async () => {
            const file = adhanFile.files[0];
            if (file) {
                await uploadAdhan(file);
            }
        });
        
        deleteAdhanBtn.addEventListener('click', async () => {
            await deleteAdhan();
        });
        
        document.getElementById('infobtn').addEventListener('click', async function (e) {
            e.preventDefault();
        
            const newData = {
                email: email.value,
                password: password.value,
                mobile: mobile.value,
                msqname: msqNameF.value,
                lat: lat.value,
                long: long.value,
                fajr: fajrD.value,
                sunrise: sunriseD.value,
                dhuhr: dhuhrD.value,
                asr: asrD.value,
                maghrib: maghribD.value,
                isha: ishaD.value,
                hadeeth: hadeeth.value,
                advertisement: advertisement.value,
                screen: screen.value,
                backgroundImage: currentImageRef ? imagePreview.src : "noBg",
                adhan: currentAdhanRef ? adhanPreview.src : "noAdhan"
            };
        
            console.log('Updating data for user:', newData.email.split("@")[0].replace(/[.#$\[\]]/g, ""));
            console.log('Data:', newData);
        
            try {
                showLoadingMessage("ุชุญููู...");
        
                await set(ref(db, `users/${newData.email.split("@")[0].replace(/[.#$\[\]]/g, "")}`), newData);
                console.log('Data successfully updated');
                alert("ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ");
                var destination = 'clock.html?parameter=' + encodeURIComponent(newData.email.split("@")[0].replace(/[.#$\[\]]/g, ""));
                window.location.href = destination;
            } catch (error) {
                console.error('Error updating data:', error);
            } finally {
                hideLoadingMessage();
            }
        });
        // here added code for background images uploading
        async function uploadImage(file) {
        loadingScreen.style.display = 'flex'; // Show loading screen

        // Delete the previous image if it exists
        if (currentImageRef) {
            try {
                console.log(currentImageRef);
                await deleteObject(currentImageRef);
                console.log("Previous image deleted successfully.");
            } catch (error) {
                console.error("Error deleting previous image:", error);
            }
        }

        // Upload the new image
        const newImagePath = 'backgroundImages/' + email.value.split("@")[0].replace(/[.#$\[\]]/g, "") + '/' + file.name;
        const newImageRef = storageRef(storage, newImagePath);
        const uploadTask = uploadBytes(newImageRef, file);

        try {
            const snapshot = await uploadTask;
            const url = await getDownloadURL(snapshot.ref);

            // Update the Firebase database with the new image URL
            await set(ref(db, `users/${parameterValue}/backgroundImage`), url);

            // Set the new image as the preview and update the current reference
            setImagePreview(url);
            currentImageRef = newImageRef; // Update the reference to the new image
        } catch (error) {
            console.error("Error uploading image:", error);
        } finally {
            loadingScreen.style.display = 'none'; // Hide loading screen
        }
    }
        
        function setImagePreview(url) {
            imagePreview.src = url;
            imagePreview.style.display = "block";
            bgImage.style.display = "none";
            currentImageRef = storageRef(storage, 'backgroundImages/' + email.value.split("@")[0].replace(/[.#$\[\]]/g, "") + '/' + url.split('/').pop());
            
            
        }
        
        // here added code for adhen files
        async function uploadAdhan(file) {
            loadingScreen.style.display = 'flex'; // Show loading screen
            const adhanRef = storageRef(storage, `adhans/${file.name}`);
            const uploadTask = uploadBytes(adhanRef, file);
        
            try {
                const snapshot = await uploadTask;
                const url = await getDownloadURL(snapshot.ref);
                await set(ref(db, `users/${parameterValue}/adhan`), url);
                setAdhanPreview(url);
            } catch (error) {
                console.error("Error uploading Adhan:", error);
            } finally {
                loadingScreen.style.display = 'none'; // Hide loading screen
            }
        }
        
        async function deleteAdhan() {
            loadingScreen.style.display = 'flex'; // Show loading screen
            if (currentAdhanRef) {
                try {
                    await deleteObject(currentAdhanRef);
                    await set(ref(db, `users/${parameterValue}/adhan`), "noAdhan");
                    adhanPreview.style.display = 'none';
                    adhanFile.style.display = 'block';
                    deleteAdhanBtn.style.display = 'none';
                } catch (error) {
                    console.error("Error deleting Adhan:", error);
                } finally {
                    loadingScreen.style.display = 'none'; // Hide loading screen
                }
            }
        }

        function setAdhanPreview(url) {
            adhanPreview.src = url;
            adhanPreview.style.display = "block";
            adhanFile.style.display = "none";
            deleteAdhanBtn.style.display = "block";
            currentAdhanRef = storageRef(storage, `adhans/${url.split('/').pop()}`);
        }
        
        // here added code for saving data in firebase
        function fillFormFields(data) {
            email.value = data.email || '';
            password.value = data.password || '';
            mobile.value = data.mobile || '';
            msqNameF.value = data.msqName || '';
            lat.value = data.lat || '';
            long.value = data.long || '';
            fajrD.value = data.fajr || '';
            sunriseD.value = data.sunrise || '';
            dhuhrD.value = data.dhuhr || '';
            asrD.value = data.asr || '';
            maghribD.value = data.maghrib || '';
            ishaD.value = data.isha || '';
            hadeeth.value = data.hadeeth || '';
            advertisement.value = data.advertisement || '';
            screen.value = data.screen || '';
        }
        
        function getParameterByName(name) {
            const url = new URL(window.location.href);
            const value = url.searchParams.get(name);
            return value ? decodeURIComponent(value) : null;
        }
        
        // here added code to show loading messages
        function showLoadingMessage(message) {
            loadingScreen.style.display = 'flex';
            loadingScreen.innerHTML = `<div>${message}</div>`;
        }
        
        function hideLoadingMessage() {
            loadingScreen.style.display = 'none';
        }
        </script>
</body>
</html>
